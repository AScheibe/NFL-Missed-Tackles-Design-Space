```{r}
library(tidyverse)

# Initialize an empty data frame to store the average x values
average_x_values = data.frame(playId = integer(), avg_x = numeric())

# Loop through each tracking file to calculate average "x" per playId
for (week in 1:9) {
  # Generate the file name
  file_name = paste0("data/tracking_week_", week, ".csv")
  
  # Load the tracking data for the current week
  tracking_data = read.csv(file_name)
  
  # Calculate the average "x" for each playId in the current file
  weekly_avg_x = tracking_data %>%
    group_by(playId) %>%
    summarize(avg_x = mean(x, na.rm = TRUE))
  
  # Append the weekly averages to the main data frame
  average_x_values = bind_rows(average_x_values, weekly_avg_x)
}

final_avg_x = average_x_values %>%
  group_by(playId) %>%
  summarize(avg_x = mean(avg_x, na.rm = TRUE))

# Load the tackles.csv file
tackles_data = read.csv("data/tackles.csv")

# Merge the average "x" values with tackles.csv based on playId
updated_tackles = tackles_data %>%
  left_join(final_avg_x, by = "playId")

# Save the updated tackles.csv file with the new average x values
write.csv(updated_tackles, "data/tackles_with_avg_x.csv", row.names = FALSE)

# Display message upon successful completion
cat("Updated tackles.csv with average x values saved as tackles_with_avg_x.csv\n")
```

```{r}
# Initialize an empty data frame to store the average y values
average_y_values = data.frame(playId = integer(), avg_y = numeric())

# Loop through each tracking file to calculate average "y" per playId
for (week in 1:9) {
  # Generate the file name
  file_name = paste0("data/tracking_week_", week, ".csv")
  
  # Load the tracking data for the current week
  tracking_data = read.csv(file_name)
  
  # Calculate the average "y" for each playId in the current file
  weekly_avg_y = tracking_data %>%
    group_by(playId) %>%
    summarize(avg_y = mean(y, na.rm = TRUE))
  
  # Append the weekly averages to the main data frame
  average_y_values = bind_rows(average_y_values, weekly_avg_y)
}

# Calculate the final average y for each playId across weeks
final_avg_y = average_y_values %>%
  group_by(playId) %>%
  summarize(avg_y = mean(avg_y, na.rm = TRUE))

# Load the tackles.csv file
tackles_data = read.csv("data/tackles_with_avg_x.csv")

# Merge the average "y" values with tackles.csv based on playId
updated_tackles_y = tackles_data %>%
  left_join(final_avg_y, by = "playId")
```


```{r}
tackles <- read_csv("data/tackles_with_avg_x_and_y.csv")
plays <- read_csv("data/plays.csv")
players <- read_csv("data/players.csv")
games <- read_csv("data/games.csv")

# Merge datasets based on common columns
data <- tackles %>%
  left_join(plays, by = c("gameId", "playId")) %>%
  left_join(players, by = "nflId") %>%
  left_join(games, by = "gameId")

write.csv(data, "data/working_data.csv", row.names = FALSE)
```

```{r}
library(tidyverse)
library(shiny)
library(plotly)
library(DT)

# Load the necessary data
data <- read_csv("data/working_data.csv")

# Define field dimensions
field_length <- 120  # yards including end zones
field_width <- 53.3  # yards

# Create the heatmap plot with football field dimensions and yard markers
tackle_heatmap <- ggplot(data, aes(x = avg_x, y = avg_y)) +
  geom_bin2d(bins = 60) +
  scale_fill_gradient(low = "blue", high = "red") +
  scale_x_continuous(breaks = seq(0, field_length, by = 10), limits = c(0, field_length), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, field_width), expand = c(0, 0)) +
  labs(title = "Tackle Position Heatmap", x = "Yard Line", y = "Field Width (Yards)") +
  theme_minimal() +
  theme(
    aspect.ratio = field_width / field_length,
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed")
  )

# Define UI
ui <- fluidPage(
  titlePanel("NFL Tackle Analysis"),
  tabsetPanel(
    tabPanel("Tackle Heatmap",
             plotlyOutput("heatmapPlot", height = "800px"),
             DTOutput("heatmapDataTable")
    ),
    tabPanel("Player Density by Yard Line",
             sidebarLayout(
               sidebarPanel(
                 sliderInput("yardLineRange", "Yard Line Range:", min = 0, max = field_length, value = c(0, field_length))
               ),
               mainPanel(
                 plotlyOutput("densityPlot")
               )
             )
    ),
    tabPanel("Average Tackle Distance",
             sidebarLayout(
               sidebarPanel(
                 selectInput("playerID", "Select Player:", choices = unique(data$player_id)),
                 sliderInput("timeRange", "Time Range (Seconds):", min = 0, max = 60, value = c(0, 60))
               ),
               mainPanel(
                 plotlyOutput("distancePlot")
               )
             )
    )
  )
)

# Define server logic
server <- function(input, output) {
  # Heatmap Plot
  output$heatmapPlot <- renderPlotly({
    ggplotly(tackle_heatmap, source = "heatmap_click")
  })

  # Update table based on clicks on heatmap
  observeEvent(event_data("plotly_click", source = "heatmap_click"), {
    click_data <- event_data("plotly_click", source = "heatmap_click")
    if (!is.null(click_data)) {
      x_clicked <- click_data$x
      y_clicked <- click_data$y
      clicked_data <- data %>%
        filter(abs(avg_x - x_clicked) < 1, abs(avg_y - y_clicked) < 1)

      output$heatmapDataTable <- renderDT({
        datatable(clicked_data)
      })
    }
  })

  # Density Plot by Yard Line
  output$densityPlot <- renderPlotly({
    filtered_data <- data %>% filter(avg_x >= input$yardLineRange[1], avg_x <= input$yardLineRange[2])
    density_plot <- ggplot(filtered_data, aes(x = avg_x)) +
      geom_density(fill = "green", alpha = 0.5) +
      labs(title = "Player Density by Yard Line", x = "Yard Line", y = "Density")
    ggplotly(density_plot)
  })

  # Average Tackle Distance Plot
  output$distancePlot <- renderPlotly({
    filtered_data <- data %>%
      filter(player_id == input$playerID, time >= input$timeRange[1], time <= input$timeRange[2])
    avg_distance_plot <- ggplot(filtered_data, aes(x = time, y = distance)) +
      geom_line(color = "purple") +
      labs(title = "Average Tackle Distance Over Time", x = "Time (Seconds)", y = "Distance (Yards)")
    ggplotly(avg_distance_plot)
  })
}

# Run the application
shinyApp(ui = ui, server = server)



```

